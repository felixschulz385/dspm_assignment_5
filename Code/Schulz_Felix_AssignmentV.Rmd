---
title: 'Assignment V: GitHub and the ticketmaster.com API'
author: "Felix Schulz"
date: "12/26/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Setting up a new GitHub repository

I set up a public github repo that is accessible using the link
[https://github.com/felixschulz385/dspm_assignment_5.git](https://github.com/felixschulz385/dspm_assignment_5.git).

## 2. Getting to know the API

We import the key from an external .R file for security reasons.

```{r}
source("api_key.R")
```

## 3. Interacting with the API - the basics

The required packages are imported:

```{r, message = F}
# Core packages
library(httr)
library(jsonlite)
# Additional packages
library(tidyverse)
library(data.table)
```

We also set up lists to contain API responses.

```{r}
responses = list()
```


Because we will make frequent calls to the API, I set up a function to wrap the
API call and simplify my code.

```{r}
ticketmaster_GET = function(endpoint, params = NULL, api_key){
  GET(paste0("https://app.ticketmaster.com/discovery/v2/",
             endpoint,
             ".json"),
      query = c(list("apikey" = api_key),
                params))
}
```

The first request to the API requests data from the *venues*-endpoint.

```{r}
responses$"venues_DE" = ticketmaster_GET("venues", 
                                         list("countryCode" = "DE"),
                                         api_key)
```

The response is parsed.

```{r}
venue_data = 
  responses$"venues_DE" %>%
  # Retrieve the content as a string
  content(as = "text") %>%
  # Parse the json string
  fromJSON() %>%
  # Get the resulting data frame
  pluck("_embedded", "venues") %>%
  # Retrieve the nested coordinates
  unnest(c(city, address, location), names_repair = "unique") %>%
  # Select the required columns
  select(name = "name...1", city = "name...10", postalCode, address = "line1", url, longitude, latitude) %>%
    # Choose appropriate data types
    mutate(across(c(postalCode, longitude, latitude), as.double))
glimpse(venue_data)
```

## Interacting with the API - advanced

The maximum amount of rows retrievable from one function call is 500. Therefore,
I choose this page size to reduce the amount of calls to API as much as 
possible.


```{r}
ticketmaster_GET_all_venues = function(params = NULL, api_key){
  ## Get the amount of total rows
  # Make an initial API call to get the total amount
  N_total_rows = 
    ticketmaster_GET("venues", 
                     c(params,
                          "size" = 1),
                     api_key) %>%
  # Retrieve the content as a string
  content(as = "text") %>%
  # Parse the json string
  fromJSON() %>%
  pluck("page", "totalElements")
  
  ## Create a blank list to store the output
  tmp = rep_len(NA, N_total_rows %/% 500 + 1) %>% as.list()
  
  ##
  for(i in seq_len(N_total_rows %/% 500 + 1)){
  tmp[[i]] = 
    # Make the API call
    ticketmaster_GET("venues", 
                     c(params,
                          "size" = 500,
                          "page" = (i - 1)),
                     api_key) %>%
    # Retrieve the content as a string
    content(as = "text") %>%
    # Parse the json string
    fromJSON() %>%
    # Get the resulting data frame
    pluck("_embedded", "venues") %>%
    # Retrieve the nested coordinates
    unnest(c(city, address, location), names_repair = "unique") %>%
    # Select the required columns
    select(name = "name...1", 
           city = ifelse(any(colnames(.) == "name...9"), "name...9", "name...10"), 
           postalCode, address = "line1", url, longitude, latitude) %>%
    # Choose appropriate data types
    mutate(across(c(postalCode, longitude, latitude), as.double))
  # Enforce the 5 calls/second rate limit
  Sys.sleep(.2)
  }
  return(tmp %>% rbindlist())
}
```

```{r, message = F}
venue_data = 
  ticketmaster_GET_all_venues(list("countryCode" = "DE"), api_key)
  
glimpse(venue_data)
```

## Visualizing the extracted data

```{r}
ggplot() + 
  geom_polygon(
    aes(x = long, y = lat, group = group), 
    data = map_data("world", region = "Germany"),
    fill = "grey90", color = "black") +
  geom_point(aes(x = longitude, y = latitude),
             data = 
               venue_data %>%
               filter(!is.na(longitude) & !is.na(latitude),
                      longitude > 5.866944 & longitude < 15.043611,
                      latitude > 47.271679 & latitude < 55.0846)) +
  theme_void() + 
  coord_quickmap() +
  labs(title = "Event locations across Germany", caption = "Source: ticketmaster.com") + 
  theme(title = element_text(size=8, face='bold'),
        plot.caption = element_text(face = "italic"))
```

However, I believe there is a much more comprehensive way of displaying the data.
Since `r venue_data %>% filter(is.na(latitude) | is.na(longitude)) %>% nrow() / venue_data %>% nrow()` 
of all venues do not have coordinates assigned to them, one should display them
by their postal code to grasp the entirety of the data. This approach requires a 
download of a 80MB shape file for the German counties. For future re-runs of
this code, this section is therefore not run by default.

```{r}
library(sf)
library(rmapshaper)

correspondence = 
  read_csv2("/Users/felixschulz/OneDrive/Dokumente/Uni/Data Science Project Management 2021-2022/Assignment 5/Data/georef-germany-postleitzahl.csv") %>%
  summarise(postalCode = as.double(`Postleitzahl / Post code`),
            countyCode = `Kreis code`)

map = read_sf("/Users/felixschulz/OneDrive/Dokumente/Uni/Data Science Project Management 2021-2022/Assignment 5/Data/georef-germany-kreis") %>%
  select(countyCode = krs_code) %>%
  ms_simplify()

map_dat = venue_data %>%
  left_join(correspondence, by = "postalCode") %>%
  group_by(countyCode) %>%
  summarise(n_venues = n_distinct(name)) %>%
  ungroup() %>%
  full_join(map, by = "countyCode") %>%
  mutate(n_venues = ifelse(is.na(n_venues), 0, n_venues)) %>%
  st_sf()

ggplot() +
  geom_sf(aes(fill = n_venues + 1), 
          size = .1, data = map_dat) +
  scale_fill_viridis_c(trans = "log", 
                       breaks = c(2, 11, 101),
                       labels = ~ .x - 1) +
  theme_void() +
  labs(title = "Density of event locations across Germany", 
       caption = "Source: ticketmaster.com",
       fill = "Number\nof\nvenues") + 
  theme(title = element_text(size=8, face='bold'),
        plot.caption = element_text(face = "italic"))

```


